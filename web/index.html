<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Siren Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.24/dist/full.min.css" rel="stylesheet" />
</head>
<body class="bg-base-200 text-base-content">
  <div class="navbar bg-base-300 px-4 sticky top-0 z-50">
    <div class="flex-1"><span class="btn btn-ghost text-xl">Siren</span></div>
    <div class="flex-none gap-2">
      <a id="subBtn" class="btn btn-outline" href="/sub">Open /sub</a>
      <span id="status" class="badge badge-ghost">idle</span>
    </div>
  </div>

  <main class="max-w-5xl mx-auto p-4 space-y-6">
    <!-- Get Links -->
    <section class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">Client Links</h2>
        <div class="flex gap-2">
          <button id="getLinks" class="btn btn-primary">Fetch /link</button>
          <button id="copyLinks" class="btn">Copy</button>
        </div>
        <textarea id="linksBox" class="textarea textarea-bordered w-full h-40 mt-3" readonly></textarea>
        <p class="text-sm opacity-70">Tombol ini memanggil <code>/link</code> pada Worker dan menampilkan vmess/vless/trojan/ss.</p>
      </div>
    </section>

    <!-- Connect Tunnel (/:proxyip) -->
    <section class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">Tunnel WebSocket (/:proxyip)</h2>

        <div class="form-control gap-2">
          <label class="label">
            <span class="label-text">Masukkan <b>proxyip</b></span>
            <span class="label-text-alt opacity-70">
              Contoh: <code>1.2.3.4:8080</code> → otomatis jadi <code>1.2.3.4-8080</code>, atau kode KV: <code>KR</code>, <code>JP</code>, <code>KR,JP</code>
            </span>
          </label>
          <input id="proxyInput" class="input input-bordered" placeholder="KR,JP atau 1.2.3.4:8080" />
        </div>

        <div class="flex gap-2 pt-2">
          <button id="connectBtn" class="btn btn-accent">Connect WS</button>
          <button id="closeBtn" class="btn">Close</button>
        </div>

        <div class="mt-3">
          <div class="collapse bg-base-200">
            <input type="checkbox" />
            <div class="collapse-title text-md font-medium">Log</div>
            <div class="collapse-content">
              <pre id="log" class="whitespace-pre-wrap text-sm"></pre>
            </div>
          </div>
        </div>

        <p class="text-sm opacity-70">
          Halaman ini akan membuka <code>wss://&lt;host&gt;/&lt;proxyip&gt;</code>.
          Worker kamu akan mendeteksi header <code>Upgrade: websocket</code> dan menjalankan handler <code>tunnel()</code>.
        </p>
      </div>
    </section>
  </main>

  <footer class="footer footer-center p-6 bg-base-300">
    <aside>© 2025 Siren</aside>
  </footer>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    let ws = null;

    function setStatus(s){ statusEl.textContent = s; }
    function log(...a){ logEl.textContent += a.join(' ') + "\n"; }

    // --- /link ---
    document.getElementById('getLinks').onclick = async () => {
      setStatus('loading /link…');
      try {
        const res = await fetch('/link');
        const text = await res.text();
        document.getElementById('linksBox').value = text.trim();
        setStatus('ok');
      } catch (e) {
        setStatus('error'); log('link error:', e);
      }
    };
    document.getElementById('copyLinks').onclick = async () => {
      const t = document.getElementById('linksBox').value;
      if (!t) return;
      await navigator.clipboard.writeText(t);
    };

    // --- /:proxyip (WebSocket) ---
    function normalizeProxyPath(s){
      s = (s || '').trim();
      // support "ip:port" -> "ip-port" for your tunnel()
      if (/^[^\s:]+:\d+$/.test(s)) return s.replace(':','-');
      // support "KR,JP" etc (handled by PROXYKV_PATTERN and KV logic in your worker)
      return s; 
    }

    document.getElementById('connectBtn').onclick = () => {
      const raw = document.getElementById('proxyInput').value;
      const proxyPath = normalizeProxyPath(raw);
      if (!proxyPath) return alert('Isi proxyip dulu');

      const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/' + encodeURIComponent(proxyPath);
      log('connecting to', url);
      setStatus('connecting');

      try {
        ws = new WebSocket(url); // browser will send Upgrade: websocket
        ws.onopen = () => { setStatus('connected'); log('WS open'); };
        ws.onclose = (e) => { setStatus('closed'); log('WS close', e.code, e.reason || ''); };
        ws.onerror = (e) => { setStatus('error'); log('WS error', e.message || e); };
        ws.onmessage = (msg) => { log('WS message', typeof msg.data, (''+msg.data).slice(0,200)); };
      } catch (e) {
        setStatus('error'); log('WS init error', e);
      }
    };

    document.getElementById('closeBtn').onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.close(1000, 'bye');
    };
  </script>
</body>
</html>
